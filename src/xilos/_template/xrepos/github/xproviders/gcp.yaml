# Authenticate to Google Cloud
# TODO: [ML Engineer] Add GCP_SA_KEY to your GitHub Secrets
- id: "auth"
  if: steps.check_changes.outputs.src_changed == 'true'
  name: "Authenticate to Google Cloud"
  uses: "google-github-actions/auth@v2"
  with:
    credentials_json: "${{ secrets.GCP_SA_KEY }}"

# Setup Google Cloud SDK
- name: "Set up Cloud SDK"
  if: steps.check_changes.outputs.src_changed == 'true'
  uses: "google-github-actions/setup-gcloud@v2"
  with:
    version: ">= 363.0.0"

# Configure Docker to verify valid credentials
- name: "Configure Docker"
  if: steps.check_changes.outputs.src_changed == 'true'
  run: |
    gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

# Build and Push Container
- name: "Build and Push Docker Image"
  if: steps.check_changes.outputs.src_changed == 'true'
  run: |
    DOCKER_TAG="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/repo/${{ env.IMAGE_NAME }}:${{ github.sha }}"

    docker build -f bookworm.Dockerfile -t $DOCKER_TAG .
    docker push $DOCKER_TAG

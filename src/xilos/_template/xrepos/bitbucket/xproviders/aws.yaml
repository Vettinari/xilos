- step:
    name: Build and Push Docker Image (AWS)
    image: python:3.11
    services:
      - docker
    condition:
      changesets:
        includePaths:
          - "src/**"
          - "bookworm.Dockerfile"
          - "pyproject.toml"
          - "poetry.lock"
    script:
      # TODO: Set AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION, ECR_REPO_URI in Repository variables
      - pip install awscli
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REPO_URI
      - export DOCKER_TAG="$ECR_REPO_URI:$BITBUCKET_COMMIT"
      - docker build -f bookworm.Dockerfile -t $DOCKER_TAG .
      - docker push $DOCKER_TAG
